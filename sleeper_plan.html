<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sleeper Build App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0; /* Slate 200 */
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px; /* Space for bottom nav */
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Horizontal Scroll Snap for Days */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Checkbox Animation */
        .custom-checkbox input:checked + div {
            background-color: #38bdf8;
            border-color: #38bdf8;
        }
        .custom-checkbox input:checked + div i {
            opacity: 1;
            transform: scale(1);
        }
        
        /* View Transitions */
        .view-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .view-section.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Input Styling */
        .input-dark {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s;
        }
        .input-dark:focus {
            border-color: #38bdf8;
            outline: none;
        }

        /* Cursor classes for dragging */
        /* Removed .cursor-grab to prevent hover state */
        .cursor-grabbing { cursor: grabbing !important; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Top App Bar -->
    <header class="fixed top-0 left-0 right-0 bg-slate-900/90 backdrop-blur-md border-b border-slate-800 z-50 h-16 flex items-center justify-between px-4 transition-all duration-300" id="header">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center shadow-lg shadow-sky-900/50">
                <i class="fa-solid fa-dumbbell text-white text-sm"></i>
            </div>
            <div>
                <h1 class="text-sm font-bold text-white tracking-tight leading-none">SLEEPER<span class="text-sky-400">BUILD</span></h1>
                <p class="text-[10px] text-slate-400 font-mono tracking-wider">ROLLING PPL</p>
            </div>
        </div>
        <div class="flex gap-3">
             <button onclick="resetData()" class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-slate-400 hover:text-white transition active:scale-95">
                <i class="fa-solid fa-rotate-right text-xs"></i>
            </button>
            <button onclick="downloadCSV()" class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-sky-400 hover:text-sky-300 transition active:scale-95">
                <i class="fa-solid fa-download text-xs"></i>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="pt-20 px-4 max-w-md mx-auto">
        
        <!-- === WORKOUT VIEW === -->
        <div id="view-plan" class="view-section active">
            <!-- Stats Carousel (Dynamic) -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-between h-24 relative overflow-hidden group">
                    <div class="absolute right-0 top-0 p-2 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-fire text-4xl text-sky-400"></i>
                    </div>
                    <span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Calories</span>
                    <div>
                        <span id="displayCalories" class="text-2xl font-bold text-white block">--</span>
                        <span class="text-[10px] text-emerald-400">Daily Target</span>
                    </div>
                </div>
                <div class="glass-panel p-3 rounded-xl flex flex-col justify-between h-24 relative overflow-hidden group">
                    <div class="absolute right-0 top-0 p-2 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-drumstick-bite text-4xl text-sky-400"></i>
                    </div>
                    <span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Protein</span>
                    <div>
                        <span id="displayProtein" class="text-2xl font-bold text-white block">--</span>
                        <span class="text-[10px] text-sky-400">High Priority</span>
                    </div>
                </div>
            </div>

            <!-- Day Selector (Sticky) -->
            <div class="sticky top-16 bg-slate-900/95 backdrop-blur z-40 py-2 -mx-4 mb-4 border-b border-slate-800/50">
                <!-- Removed cursor-grab from here to satisfy "only show while long pressing" -->
                <div class="flex overflow-x-auto gap-2 no-scrollbar pb-1 snap-x snap-mandatory before:content-[''] before:w-4 before:shrink-0 after:content-[''] after:w-4 after:shrink-0 select-none" id="dayTabs">
                    <!-- JS Generated -->
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="mb-6 flex items-center justify-between gap-4">
                <div class="flex-1 h-2 bg-slate-800 rounded-full overflow-hidden">
                    <div id="dayProgress" class="h-full bg-gradient-to-r from-sky-500 to-blue-600 w-0 transition-all duration-500 rounded-full"></div>
                </div>
                <span id="progressText" class="text-xs font-mono text-sky-400 font-bold">0%</span>
            </div>

            <!-- Workout Header -->
            <div class="mb-4">
                <h2 id="dayTitle" class="text-xl font-bold text-white"></h2>
                <p id="dayFocus" class="text-xs text-slate-400 mt-1"></p>
            </div>

            <!-- Exercise List -->
            <div id="workoutList" class="space-y-3 pb-4">
                <!-- JS Generated Cards -->
            </div>

            <!-- Mobility Section -->
            <div id="mobilitySection" class="mt-6 mb-8 hidden">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 ml-1">Mobility / Prehab</h3>
                <div class="glass-panel rounded-xl p-5">
                    
                    <!-- Pre-Workout Column -->
                    <div class="mb-4 border-b border-slate-700/50 pb-4">
                        <h4 class="flex items-center gap-2 text-[10px] font-bold text-sky-400 uppercase tracking-wider mb-2">
                            <i class="fa-solid fa-play text-[8px]"></i> Pre-Workout
                        </h4>
                        <ul id="mobilityPreList" class="space-y-2 text-sm text-slate-300 pl-2 border-l-2 border-sky-500/20">
                            <!-- JS Generated -->
                        </ul>
                    </div>

                    <!-- Post-Workout Column -->
                    <div>
                        <h4 class="flex items-center gap-2 text-[10px] font-bold text-emerald-400 uppercase tracking-wider mb-2">
                             <i class="fa-solid fa-check text-[8px]"></i> Post-Workout
                        </h4>
                        <ul id="mobilityPostList" class="space-y-2 text-sm text-slate-300 pl-2 border-l-2 border-emerald-500/20">
                            <!-- JS Generated -->
                        </ul>
                    </div>

                </div>
            </div>
        </div>

        <!-- === GOALS VIEW === -->
        <div id="view-goals" class="view-section">
            <h2 class="text-2xl font-bold text-white mb-6">Your Goals</h2>
            
            <div class="glass-panel p-6 rounded-2xl mb-6">
                <h3 class="text-sky-400 text-sm font-bold uppercase mb-4">Body Metrics</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Current Waist (inches)</label>
                        <input type="number" id="currentWaist" class="w-full p-3 rounded-lg input-dark" placeholder="34.5">
                    </div>
                     <div>
                        <label class="block text-xs text-emerald-400 mb-1 font-bold">Target Waist (inches)</label>
                        <input type="number" id="targetWaist" class="w-full p-3 rounded-lg input-dark border-emerald-500/30" placeholder="30.0">
                    </div>
                </div>
            </div>

             <div class="glass-panel p-6 rounded-2xl mb-6">
                <h3 class="text-sky-400 text-sm font-bold uppercase mb-4">Weight</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Current Weight (kg)</label>
                        <input type="number" id="currentWeight" class="w-full p-3 rounded-lg input-dark" placeholder="76.5">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Goal Weight (kg)</label>
                        <input type="number" id="targetWeight" class="w-full p-3 rounded-lg input-dark" placeholder="75.0">
                    </div>
                </div>
            </div>

            <button onclick="saveSettings()" class="w-full py-4 bg-sky-600 hover:bg-sky-500 text-white font-bold rounded-xl transition shadow-lg shadow-sky-900/50">
                Save Body Metrics
            </button>
        </div>

        <!-- === DIET VIEW === -->
        <div id="view-diet" class="view-section">
            <h2 class="text-2xl font-bold text-white mb-6">Diet Targets</h2>

            <div class="glass-panel p-6 rounded-2xl mb-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-5">
                    <i class="fa-solid fa-utensils text-6xl"></i>
                </div>
                <h3 class="text-sky-400 text-sm font-bold uppercase mb-4">Daily Macros</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Daily Calories (kcal)</label>
                        <input type="number" id="targetCalories" class="w-full p-3 rounded-lg input-dark text-lg font-bold" placeholder="2310">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-[10px] text-slate-400 mb-1 uppercase">Protein (g)</label>
                            <input type="number" id="targetProtein" class="w-full p-2 rounded-lg input-dark text-center" placeholder="175">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400 mb-1 uppercase">Carbs (g)</label>
                            <input type="number" id="targetCarbs" class="w-full p-2 rounded-lg input-dark text-center" placeholder="245">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400 mb-1 uppercase">Fats (g)</label>
                            <input type="number" id="targetFats" class="w-full p-2 rounded-lg input-dark text-center" placeholder="70">
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-4 rounded-xl mb-6 bg-slate-800/50">
                <div class="flex items-start gap-3">
                    <i class="fa-solid fa-circle-info text-sky-400 mt-1"></i>
                    <p class="text-xs text-slate-400 leading-relaxed">
                        To hit the "Sleeper" look, prioritize Protein (175g). Adjust Carbs down to 205g if waist progress stalls after 3 weeks.
                    </p>
                </div>
            </div>

            <button onclick="saveSettings()" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl transition shadow-lg shadow-emerald-900/50">
                Update Diet Targets
            </button>
        </div>

    </main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 bg-slate-900/90 backdrop-blur-lg border-t border-slate-800 pb-safe pt-2 px-6 flex justify-around items-center h-[80px] z-50">
        <button onclick="switchView('plan')" id="nav-plan" class="nav-btn flex flex-col items-center gap-1 text-sky-400 transition-colors">
            <i class="fa-solid fa-list-check text-xl mb-1"></i>
            <span class="text-[10px] font-medium">Workout</span>
        </button>
        <button onclick="switchView('goals')" id="nav-goals" class="nav-btn flex flex-col items-center gap-1 text-slate-500 hover:text-slate-300 transition-colors">
            <i class="fa-solid fa-bullseye text-xl mb-1"></i>
            <span class="text-[10px] font-medium">Goals</span>
        </button>
        <button onclick="switchView('diet')" id="nav-diet" class="nav-btn flex flex-col items-center gap-1 text-slate-500 hover:text-slate-300 transition-colors">
            <i class="fa-solid fa-utensils text-xl mb-1"></i>
            <span class="text-[10px] font-medium">Diet</span>
        </button>
    </nav>

    <script>
        // --- Data: Rolling PPL 3 On / 1 Off ---
        const workoutData = [
            {
                id: "Push A",
                type: "workout",
                title: "Push A (Heavy)",
                focus: "Strength & Front Delts",
                exercises: [
                    { id: 'p1_1', name: "Incline Barbell Pause Press", sets: "4", reps: "4–6", notes: "Pause 1s at bottom." },
                    { id: 'p1_2', name: "Seated DB Shoulder Press", sets: "4", reps: "6–8", notes: "Heavy. Flat back." },
                    { id: 'p1_3', name: "Close-Grip Bench Press", sets: "3", reps: "6–8", notes: "Triceps/Front Delt." },
                    { id: 'p1_4', name: "Weighted Dips", sets: "3", reps: "6–10", notes: "Or Decline Press." },
                    { id: 'p1_5', name: "DB Lateral Raises", sets: "4", reps: "10–12", notes: "Strict form." },
                    { id: 'p1_6', name: "Plate Front Raise", sets: "2", reps: "10–12", notes: "Light weight." },
                    { id: 'p1_7', name: "Face Pulls", sets: "3", reps: "15", notes: "Rear delts." },
                    { id: 'p1_8', name: "Rope Triceps Pressdown", sets: "3", reps: "10–12", notes: "Squeeze." }
                ],
                mobility: {
                    pre: ["Band Pull-aparts (2x15)", "Ext. Rotations (2x12)"],
                    post: ["Doorway Chest Stretch (2x30s)", "Triceps Overhead Stretch"]
                }
            },
            {
                id: "Pull A",
                type: "workout",
                title: "Pull A (Heavy)",
                focus: "Mid-back & Lats",
                exercises: [
                    { id: 'pl1_1', name: "Barbell Rows", sets: "4", reps: "4–6", notes: "Explosive pull." },
                    { id: 'pl1_2', name: "Wide-Grip Pull-Ups", sets: "4", reps: "AMRAP", notes: "Focus on Lats." },
                    { id: 'pl1_3', name: "Chest-Supported DB Rows", sets: "3", reps: "8–10", notes: "Squeeze scapula." },
                    { id: 'pl1_4', name: "Smith Machine Shrugs", sets: "3", reps: "8–12", notes: "Hold 2s top." },
                    { id: 'pl1_5', name: "Hammer Curls", sets: "3", reps: "8–12", notes: "Brachialis." },
                    // UPDATED with Alternate
                    { 
                        id: 'pl1_6', 
                        name: "Farmer's Carry", 
                        sets: "2", 
                        reps: "60s", 
                        notes: "Forearm critical.",
                        alt: {
                            name: "Wrist Curls",
                            sets: "2",
                            reps: "12–15",
                            notes: "Forearm isolation."
                        }
                    }
                ],
                mobility: {
                    pre: ["T-Spine Rotations (2x12)", "Cat-Cow Stretch"],
                    post: ["Dead Hang (60s)", "Lat Stretch (2x30s)"]
                }
            },
            {
                id: "Legs A",
                type: "workout",
                title: "Legs A (Heavy)",
                focus: "Posterior Chain",
                exercises: [
                    { id: 'l1_1', name: "Back Squats", sets: "4", reps: "4–6", notes: "Primary strength." },
                    { id: 'l1_2', name: "Romanian Deadlifts", sets: "3", reps: "6–8", notes: "Hinge deep." },
                    { id: 'l1_3', name: "Leg Press", sets: "3", reps: "8–12", notes: "Volume." },
                    { id: 'l1_4', name: "Seated Calf Raises", sets: "4", reps: "10–15", notes: "Full stretch." },
                    { id: 'l1_5', name: "Hanging Leg Raises", sets: "3", reps: "10–15", notes: "Core." }
                ],
                mobility: {
                    pre: ["Leg Swings (Dynamic)", "Bodyweight Squats"],
                    post: ["90/90 Hip Stretch", "Pigeon Pose"]
                }
            },
            {
                id: "Rest",
                type: "rest",
                title: "Rest Day",
                focus: "Recovery",
                exercises: [
                    { id: 'r1_1', name: "LISS Cardio (Opt)", sets: "1", reps: "20m", notes: "Walk/Cycle." },
                    { id: 'r1_2', name: "Full Body Stretch", sets: "1", reps: "15m", notes: "Relax." }
                ],
                mobility: {
                    pre: ["Light Walk (5 mins)"],
                    post: ["Foam Rolling (Full Body)", "Deep Breathing"]
                }
            },
            {
                id: "Push B",
                type: "workout",
                title: "Push B (Hyp)",
                focus: "Shoulder Shape",
                exercises: [
                    { id: 'p2_1', name: "Standing OH DB Press", sets: "3", reps: "8–10", notes: "Core tight." },
                    { id: 'p2_2', name: "Flat Barbell Bench", sets: "3", reps: "8–10", notes: "Volume work." },
                    { id: 'p2_3', name: "Incline DB Flyes", sets: "3", reps: "10–12", notes: "Deep stretch." },
                    { id: 'p2_tri', name: "Overhead Cable Rope Ext", sets: "2–3", reps: "10–12", notes: "Rope behind head. Light-mod load." },
                    // UPDATED with Alternate
                    { 
                        id: 'p2_4', 
                        name: "Low Cable Crossover", 
                        sets: "3", 
                        reps: "12", 
                        notes: "Upper chest.",
                        alt: {
                            name: "High Cable Crossover",
                            sets: "3",
                            reps: "12",
                            notes: "Lower chest focus."
                        }
                    },
                    { id: 'p2_5', name: "Leaning Lateral Raises", sets: "3", reps: "12", notes: "Side delts." },
                    { id: 'p2_6', name: "Ab Rollouts", sets: "3", reps: "8–12", notes: "Core." }
                ],
                mobility: {
                    pre: ["Band Ext. Rotations (2x15)", "Arm Circles"],
                    post: ["Doorway Stretch", "Biceps Wall Stretch"]
                }
            },
            {
                id: "Pull B",
                type: "workout",
                title: "Pull B (Hyp)",
                focus: "Detail & Rear Delts",
                exercises: [
                    { id: 'pl2_1', name: "Close-Grip Pulldowns", sets: "3", reps: "10–12", notes: "Elbows down." },
                    { id: 'pl2_2', name: "One-Arm DB Rows", sets: "3", reps: "10", notes: "To hip pocket." },
                    { id: 'pl2_3', name: "Reverse Pec-Deck", sets: "3", reps: "15", notes: "Rear delts." },
                    // UPDATED with Alternate
                    { 
                        id: 'pl2_4', 
                        name: "Cable Curls", 
                        sets: "3", 
                        reps: "12", 
                        notes: "Biceps.",
                        alt: {
                            name: "Incline DB Curl",
                            sets: "2–3",
                            reps: "10–12",
                            notes: "Long head focus."
                        }
                    },
                    { id: 'pl2_5', name: "Pallof Press", sets: "3", reps: "10", notes: "Anti-rotation." },
                    { id: 'pl2_6', name: "Reverse Wrist Curls", sets: "2", reps: "15", notes: "Forearms." }
                ],
                mobility: {
                    pre: ["T-Spine Rotations", "Band Pull-aparts"],
                    post: ["Lat Stretch", "Forearm/Wrist Stretch"]
                }
            },
            {
                id: "Legs B",
                type: "workout",
                title: "Legs B (Hyp)",
                focus: "Unilateral & Detail",
                exercises: [
                    { id: 'l2_1', name: "Front Squats", sets: "3", reps: "6–8", notes: "Upright torso." },
                    { id: 'l2_2', name: "Lying Leg Curls", sets: "3", reps: "12", notes: "Hamstrings." },
                    { id: 'l2_3', name: "Bulgarian Split Squats", sets: "3", reps: "10", notes: "Glutes/Quads." },
                    { id: 'l2_4', name: "Standing Calf Raises", sets: "4", reps: "15", notes: "Straight knee." },
                    { id: 'l2_5', name: "Cable Crunch", sets: "3", reps: "15", notes: "Abs." }
                ],
                mobility: {
                    pre: ["Ankle Circles", "Walking Lunges"],
                    post: ["Foam Roll Quads", "Couch Stretch"]
                }
            },
             {
                id: "Rest",
                type: "rest",
                title: "Rest Day",
                focus: "Recovery",
                exercises: [
                    { id: 'r2_1', name: "Meal Prep", sets: "1", reps: "-", notes: "Plan macros." },
                    { id: 'r2_2', name: "Full Body Stretch", sets: "1", reps: "15m", notes: "Relax." }
                ],
                mobility: {
                    pre: ["Light Walk"],
                    post: ["Yoga / Stretching Flow", "Meditation"]
                }
            }
        ];

        // --- App State ---
        let currentDayIdx = 0;
        let completionState = JSON.parse(localStorage.getItem('sleeperApp_state')) || {};
        let alternateState = JSON.parse(localStorage.getItem('sleeperApp_alts')) || {}; // Store swaps
        
        // Drag State
        let isDragging = false;
        
        // Default Settings
        const defaultSettings = {
            calories: 2310,
            protein: 175,
            carbs: 245,
            fats: 70,
            currentWaist: 34.5,
            targetWaist: 30.0,
            currentWeight: 76.5,
            targetWeight: 75.0
        };
        let userSettings = JSON.parse(localStorage.getItem('sleeperApp_settings')) || defaultSettings;

        // --- Core Functions ---

        function init() {
            renderTabs();
            renderDay();
            loadSettingsToInputs();
            updateDashboard();
            enableDragScroll(); // Init Drag
        }

        // View Navigation
        function switchView(viewName) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            // Show target view
            document.getElementById(`view-${viewName}`).classList.add('active');

            // Update Nav Icons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-sky-400');
                btn.classList.add('text-slate-500');
            });
            const activeBtn = document.getElementById(`nav-${viewName}`);
            activeBtn.classList.remove('text-slate-500');
            activeBtn.classList.add('text-sky-400');
        }

        function renderTabs() {
            const container = document.getElementById('dayTabs');
            container.innerHTML = '';
            
            workoutData.forEach((day, index) => {
                const btn = document.createElement('button');
                const isActive = index === currentDayIdx;
                
                // Style logic for active vs inactive
                const activeClass = "bg-sky-600 text-white shadow-lg shadow-sky-900/50 scale-105 border-sky-500";
                const inactiveClass = "bg-slate-800 text-slate-400 border-slate-700";
                const restClass = day.type === 'rest' ? 'border-emerald-500/30' : '';

                btn.className = `flex-shrink-0 w-16 h-14 rounded-xl flex flex-col items-center justify-center border transition-all duration-200 snap-center ${isActive ? activeClass : inactiveClass} ${restClass}`;
                
                // Shorten title for tab
                let tabTitle = day.id; 
                if(tabTitle.includes(" ")) {
                    const parts = tabTitle.split(" ");
                    tabTitle = `<span class="text-[9px] uppercase">${parts[0]}</span><span class="text-lg leading-none">${parts[1]}</span>`;
                } else {
                     tabTitle = `<span class="text-sm font-bold uppercase">${tabTitle}</span>`;
                }

                btn.innerHTML = tabTitle;
                
                btn.onclick = () => {
                    // Prevent click if we were dragging
                    if(isDragging) return;
                    
                    currentDayIdx = index;
                    renderTabs();
                    renderDay();
                };
                container.appendChild(btn);
            });
        }
        
        function enableDragScroll() {
            const slider = document.getElementById('dayTabs');
            let isDown = false;
            let startX;
            let scrollLeft;
            let pressTimer; // Timer for long press logic

            slider.addEventListener('mousedown', (e) => {
                isDown = true;
                isDragging = false; 
                
                // --- NEW LONG PRESS LOGIC ---
                // Start a timer on press. If held > 200ms, change cursor & disable snap
                pressTimer = setTimeout(() => {
                    slider.classList.add('cursor-grabbing');
                    slider.classList.remove('snap-x', 'snap-mandatory'); 
                }, 200); 

                startX = e.pageX - slider.offsetLeft;
                scrollLeft = slider.scrollLeft;
            });

            slider.addEventListener('mouseleave', () => {
                isDown = false;
                clearTimeout(pressTimer); // Cancel long press timer
                slider.classList.remove('cursor-grabbing');
                slider.classList.add('snap-x', 'snap-mandatory');
                setTimeout(() => isDragging = false, 50);
            });

            slider.addEventListener('mouseup', () => {
                isDown = false;
                clearTimeout(pressTimer); // Cancel long press timer
                slider.classList.remove('cursor-grabbing');
                slider.classList.add('snap-x', 'snap-mandatory');
                setTimeout(() => isDragging = false, 50);
            });

            slider.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - slider.offsetLeft;
                const walk = (x - startX) * 2; 
                
                if(Math.abs(x - startX) > 5) {
                    isDragging = true;
                    // Note: We intentionally do NOT force cursor-grabbing here.
                    // We let the timer decide if it's a "long press".
                    // If the user swipes fast, it just scrolls without the hand cursor.
                    slider.classList.remove('snap-x', 'snap-mandatory');
                }
                
                slider.scrollLeft = scrollLeft - walk;
            });
        }

        function renderDay() {
            const data = workoutData[currentDayIdx];
            
            document.getElementById('dayTitle').innerText = data.title;
            document.getElementById('dayFocus').innerText = `Focus: ${data.focus}`;
            
            const list = document.getElementById('workoutList');
            list.innerHTML = '';
            
            let completedCount = 0;

            if (data.type === 'rest') {
                 list.innerHTML = `<div class="p-6 text-center text-slate-500 italic">Active recovery. Eat well.</div>`;
            }

            data.exercises.forEach(ex => {
                const isChecked = completionState[ex.id] || false;
                if(isChecked) completedCount++;
                
                // --- SWITCH LOGIC ---
                // Check if currently switched to alternate
                const useAlt = alternateState[ex.id] === true;
                
                // Decide which data to show
                const displayData = (useAlt && ex.alt) ? ex.alt : ex;
                
                // Show swap button only if 'alt' exists in data
                const showSwapBtn = !!ex.alt;

                const card = document.createElement('div');
                card.className = `glass-panel p-4 rounded-2xl flex items-center justify-between gap-4 transition-all duration-300 ${isChecked ? 'opacity-60 grayscale-[0.5]' : ''}`;
                
                // Build the HTML
                card.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <h4 class="text-white font-semibold text-sm leading-tight">${displayData.name}</h4>
                            ${showSwapBtn ? 
                                `<button onclick="toggleAlternate('${ex.id}')" class="bg-slate-700 hover:bg-slate-600 text-sky-400 w-5 h-5 rounded-full flex items-center justify-center transition" title="Swap Exercise">
                                    <i class="fa-solid fa-repeat text-[10px]"></i>
                                 </button>` 
                            : ''}
                        </div>
                        <div class="flex items-center gap-3 text-xs">
                            <span class="bg-slate-800 text-sky-400 px-2 py-0.5 rounded border border-slate-700 font-mono">${displayData.sets} x ${displayData.reps}</span>
                            <span class="text-slate-400 truncate max-w-[120px] italic">${displayData.notes}</span>
                        </div>
                    </div>
                    
                    <label class="custom-checkbox cursor-pointer relative w-8 h-8 flex-shrink-0">
                        <input type="checkbox" class="hidden" ${isChecked ? 'checked' : ''} onchange="toggleExercise('${ex.id}')">
                        <div class="w-full h-full rounded-full border-2 border-slate-600 bg-slate-800/50 flex items-center justify-center transition-all duration-200 hover:border-sky-500">
                            <i class="fa-solid fa-check text-white text-xs opacity-0 transform scale-50 transition-all duration-200"></i>
                        </div>
                    </label>
                `;
                list.appendChild(card);
            });

            // Mobility
            const mobPreList = document.getElementById('mobilityPreList');
            const mobPostList = document.getElementById('mobilityPostList');
            const mobSection = document.getElementById('mobilitySection');
            
            mobPreList.innerHTML = '';
            mobPostList.innerHTML = '';
            
            if(data.mobility) {
                mobSection.classList.remove('hidden');
                if(data.mobility.pre) {
                    data.mobility.pre.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        mobPreList.appendChild(li);
                    });
                }
                if(data.mobility.post) {
                    data.mobility.post.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        mobPostList.appendChild(li);
                    });
                }
            } else {
                mobSection.classList.add('hidden');
            }

            updateProgress(completedCount, data.exercises.length);
        }

        function toggleExercise(id) {
            completionState[id] = !completionState[id];
            localStorage.setItem('sleeperApp_state', JSON.stringify(completionState));
            renderDay();
             if (window.navigator && window.navigator.vibrate) {
                window.navigator.vibrate(50); 
            }
        }
        
        function toggleAlternate(id) {
            // Toggle the boolean state for this exercise ID
            alternateState[id] = !alternateState[id];
            localStorage.setItem('sleeperApp_alts', JSON.stringify(alternateState));
            renderDay(); // Re-render to show new text
        }

        function updateProgress(done, total) {
            const percent = total === 0 ? 0 : Math.round((done / total) * 100);
            const bar = document.getElementById('dayProgress');
            const text = document.getElementById('progressText');
            
            bar.style.width = `${percent}%`;
            text.innerText = `${percent}%`;
            
            if(percent === 100) {
                bar.classList.remove('from-sky-500', 'to-blue-600');
                bar.classList.add('from-emerald-400', 'to-emerald-600');
                text.classList.replace('text-sky-400', 'text-emerald-400');
            } else {
                bar.classList.add('from-sky-500', 'to-blue-600');
                bar.classList.remove('from-emerald-400', 'to-emerald-600');
                text.classList.replace('text-emerald-400', 'text-sky-400');
            }
        }

        // --- Settings / Diet Logic ---

        function loadSettingsToInputs() {
            // Diet
            document.getElementById('targetCalories').value = userSettings.calories;
            document.getElementById('targetProtein').value = userSettings.protein;
            document.getElementById('targetCarbs').value = userSettings.carbs;
            document.getElementById('targetFats').value = userSettings.fats;
            
            // Goals
            document.getElementById('currentWaist').value = userSettings.currentWaist;
            document.getElementById('targetWaist').value = userSettings.targetWaist;
            document.getElementById('currentWeight').value = userSettings.currentWeight;
            document.getElementById('targetWeight').value = userSettings.targetWeight;
        }

        function saveSettings() {
            // Read values
            userSettings.calories = document.getElementById('targetCalories').value;
            userSettings.protein = document.getElementById('targetProtein').value;
            userSettings.carbs = document.getElementById('targetCarbs').value;
            userSettings.fats = document.getElementById('targetFats').value;
            
            userSettings.currentWaist = document.getElementById('currentWaist').value;
            userSettings.targetWaist = document.getElementById('targetWaist').value;
            userSettings.currentWeight = document.getElementById('currentWeight').value;
            userSettings.targetWeight = document.getElementById('targetWeight').value;

            // Save
            localStorage.setItem('sleeperApp_settings', JSON.stringify(userSettings));
            
            // Feedback
            updateDashboard();
            alert("Settings Saved!");
            switchView('plan'); // Return to plan
        }

        function updateDashboard() {
            document.getElementById('displayCalories').innerText = userSettings.calories;
            document.getElementById('displayProtein').innerText = userSettings.protein + 'g';
        }

        function resetData() {
            if(confirm("Factory Reset: Clear all progress, swaps, and settings?")) {
                // 1. Reset all state variables to defaults/empty
                completionState = {};
                alternateState = {};
                // Create a fresh copy of defaults to avoid reference issues
                userSettings = {
                    calories: 2310,
                    protein: 175,
                    carbs: 245,
                    fats: 70,
                    currentWaist: 34.5,
                    targetWaist: 30.0,
                    currentWeight: 76.5,
                    targetWeight: 75.0
                };

                // 2. Clear all LocalStorage keys
                localStorage.removeItem('sleeperApp_state');
                localStorage.removeItem('sleeperApp_alts');
                localStorage.removeItem('sleeperApp_settings');

                // 3. Update the UI components immediately
                loadSettingsToInputs(); // Resets the inputs in the Diet/Goals tabs
                updateDashboard();      // Resets the top bar numbers
                renderDay();            // Resets the workout list, checkboxes, and swaps
                
                // 4. Feedback
                if (window.navigator && window.navigator.vibrate) {
                    window.navigator.vibrate([50, 50, 50]); 
                }
            }
        }

        function downloadCSV() {
            let csv = "Day,Exercise,Sets,Reps,Notes\n";
            workoutData.forEach(d => {
                d.exercises.forEach(e => {
                    csv += `${d.title},"${e.name}",${e.sets},"${e.reps}","${e.notes}"\n`;
                });
            });
            const link = document.createElement("a");
            link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
            link.download = "sleeper_plan.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize
        init();

    </script>
</body>
</html>